services:
  writer-media-function:
    image: ghcr.io/cbcrc/mxl-writer:latest
    privileged: true
    user: "root"
    environment:
      - HOST_UID=${HOST_UID}
      - HOST_GID=${HOST_GID}
    volumes:
      - /Volumes/mxl:/Volumes/mxl:rw,shared
    entrypoint: >
      sh -c "
        # 1. Force Strict Atime
        mount -o remount,strictatime /Volumes/mxl && 
        
        # 2. Setup User
        groupadd -g \${HOST_GID:-1000} mxlgroup || true &&
        useradd -u \${HOST_UID:-1000} -g \${HOST_GID:-1000} mxluser || true &&
        
        # 3. FIX: Create the directory and transfer ownership to the user
        mkdir -p /Volumes/mxl/domain_1 &&
        chown mxluser:mxlgroup /Volumes/mxl/domain_1 &&
        
        # 4. Run application as user
        exec su mxluser -c '/app/mxl-gst-testsrc -d /Volumes/mxl/domain_1 -v /app/v210_flow.json -a /app/audio_flow.json'
      "

  reader-media-function:
    image: ghcr.io/cbcrc/mxl-reader:latest
    privileged: true
    user: "root"
    environment:
      - HOST_UID=${HOST_UID}
      - HOST_GID=${HOST_GID}
    volumes:
      - /Volumes/mxl:/Volumes/mxl:rw,shared
    entrypoint: >
      sh -c "
        mount -o remount,strictatime /Volumes/mxl && 
        groupadd -g \${HOST_GID:-1000} mxlgroup || true &&
        useradd -u \${HOST_UID:-1000} -g \${HOST_GID:-1000} mxluser || true &&
        # Reader just waits for the directory to appear
        exec su mxluser -c 'while true; do /app/mxl-info -d /Volumes/mxl/domain_1 -l; sleep 1; done'
      "