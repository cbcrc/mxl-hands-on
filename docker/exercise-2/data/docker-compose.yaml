services:
  writer-media-function:
    image: ghcr.io/cbcrc/mxl-writer:latest
    privileged: true
    user: "root"
    environment:
      - HOST_UID=${HOST_UID}
      - HOST_GID=${HOST_GID}
    volumes:
      - /Volumes/mxl:/Volumes/mxl:rw,shared
    entrypoint: >
      sh -c "
        mount -o remount,strictatime /Volumes/mxl && 
        groupadd -g \${HOST_GID:-1000} mxlgroup || true &&
        useradd -u \${HOST_UID:-1000} -g \${HOST_GID:-1000} mxluser || true &&
        mkdir -p /Volumes/mxl/domain_1 &&
        chown mxluser:mxlgroup /Volumes/mxl/domain_1 &&
        exec su mxluser -c '/app/mxl-gst-testsrc -d /Volumes/mxl/domain_1 -v /app/v210_flow.json -t \"Original Flow\"'
      "

  writer-media-function-2:
    image: ghcr.io/cbcrc/mxl-writer:latest
    privileged: true
    user: "root"
    environment:
      - HOST_UID=${HOST_UID}
      - HOST_GID=${HOST_GID}
    volumes:
      - /Volumes/mxl:/Volumes/mxl:rw,shared
      - ./data/v210_flow_2.json:/app/v210_flow_2.json
    entrypoint: >
      sh -c "
        mount -o remount,strictatime /Volumes/mxl && 
        groupadd -g \${HOST_GID:-1000} mxlgroup || true &&
        useradd -u \${HOST_UID:-1000} -g \${HOST_GID:-1000} mxluser || true &&
        mkdir -p /Volumes/mxl/domain_2 &&
        chown mxluser:mxlgroup /Volumes/mxl/domain_2 &&
        exec su mxluser -c '/app/mxl-gst-testsrc -d /Volumes/mxl/domain_2 -v /app/v210_flow_2.json -t \"NEW Flow 2\"'
      "

  reader-media-function:
    image: ghcr.io/cbcrc/mxl-reader:latest
    privileged: true
    user: "root"
    environment:
      - HOST_UID=${HOST_UID}
      - HOST_GID=${HOST_GID}
    volumes:
      - /Volumes/mxl:/Volumes/mxl:rw,shared
    entrypoint: >
      sh -c "
        mount -o remount,strictatime /Volumes/mxl && 
        groupadd -g \${HOST_GID:-1000} mxlgroup || true &&
        useradd -u \${HOST_UID:-1000} -g \${HOST_GID:-1000} mxluser || true &&
        exec su mxluser -c 'while true; do /app/mxl-info -d /Volumes/mxl/domain_1 -l; sleep 1; done'
      "
