# Declare build arguments for the base image
ARG BASE_IMAGE=debian:trixie-slim

FROM ${BASE_IMAGE}

# --- Final Path provided by shell script ---
ARG FULL_BUILD_PATH
# --- END Final Path provided by shell script ---

WORKDIR /app

# Use minimal dependencies and clean up in the same layer to reduce image size
RUN apt-get update && apt-get -y install --no-install-recommends \
        libgstreamer1.0-dev \
        libgstreamer-plugins-base1.0-dev \
        libgstreamer-plugins-bad1.0-dev \
        gstreamer1.0-plugins-base \
        gstreamer1.0-plugins-good \
        gstreamer1.0-plugins-bad \
        gstreamer1.0-plugins-ugly \
        gstreamer1.0-libav \
        gstreamer1.0-tools \
        gstreamer1.0-x \
        gstreamer1.0-alsa \
        gstreamer1.0-gl \
        gstreamer1.0-gtk3 \
        gstreamer1.0-qt5 \
        gstreamer1.0-pulseaudio \
        patchelf \
        # Add bash and coreutils for complex file movement
        bash \
        coreutils \
    && rm -rf /var/lib/apt/lists/*

# Copy the entire build directory content into a temporary location within the image
COPY ${FULL_BUILD_PATH} /tmp/build/

# Move only necessary files from the temp directory to /app or their target location and clean up
RUN mv /tmp/build/utils/gst-looping-filesrc /gst-plugins/ \
    && mv /tmp/build/lib/*.so* /app/ \
    && mv /tmp/build/lib/internal/libmxl-common.* /app/ \
    && mv /tmp/build/lib/tests/data/*.json /app/ \
    && mv /tmp/build/tools/mxl-gst/mxl-gst-looping-filesrc /app/ \
    # Clean up the temp directory
    && rm -rf /tmp/build

# Set environment variable for GStreamer plugin path
ENV GST_PLUGIN_PATH="/gst-plugins"

# Set rpath for the executable
RUN patchelf --set-rpath /app mxl-gst-looping-filesrc

CMD ["/app/mxl-gst-looping-filesrc", "-d", "/domain"]